function navigationClick(e,t){getData(t+".html",function(n){document.getElementById("revealContainer").innerHTML=n,chapter=t,getData("exercise/"+chapter+"/list.json",function(t){codingSlides=JSON.parse(t).codingSlides,initReveal();for(var n=document.getElementById("menu").children[1].children,o=0;o<n.length;o++)n[o].classList.remove("active");e?e.target.classList.add("active"):document.getElementById("menu").children[1].children[0].classList.add("active")})})}function initReveal(){Reveal.initialize({slideNumber:!0,center:!0,transition:"slide"}),Reveal.addEventListener("slidechanged",function(e){codingSlides.indexOf(e.indexh)>-1?getData("exercise/"+chapter+"/"+e.indexh+".json",showExercise):document.getElementById("codeSection").style.display="none"}),Reveal.slide(0,0,0)}function drawMatrix(){for(var e=1;e<ex.matrix.nrow+1;e++)for(var t=1;t<ex.matrix.ncol+1;t++)context.drawImage(backImg,(e-1)*ex.matrix.size+e,(t-1)*ex.matrix.size+t,ex.matrix.size,ex.matrix.size)}function drawImg(e,t,n){context.drawImage(e,(n-1)*ex.matrix.size+n,(t-1)*ex.matrix.size+t,ex.matrix.size,ex.matrix.size)}function initVisualView(){canvas.width=ex.matrix.ncol*ex.matrix.size+ex.matrix.ncol+1,canvas.height=ex.matrix.nrow*ex.matrix.size+ex.matrix.nrow+1,context=canvas.getContext("2d"),drawMatrix(),drawSimpson(),triggers=createMatrix(ex.matrix.nrow,ex.matrix.ncol,0),ex.holes&&ex.holes.forEach(function(e){drawImg(holeImg,e.row,e.col),triggers[e.row-1][e.col-1]=1}),ex.rocks&&ex.rocks.forEach(function(e){drawImg(rockImg,e.row,e.col),triggers[e.row-1][e.col-1]=2}),ex.diamond&&ex.diamond.forEach(function(e){drawImg(diamondImg,e.row,e.col),triggers[e.row-1][e.col-1]=3}),ex.markedDiamond&&ex.markedDiamond.forEach(function(e){drawImg(markedDiaImg,e.row,e.col)}),document.getElementById("codeSection").style.display="flex"}function showExercise(e){ex=JSON.parse(e),ex.script?editor.getSession().setValue(ex.script):editor.getSession().setValue(""),initVisualView()}function drawSimpson(){switch(ex.simpson.direction){case"dong":drawImg(eastImg,ex.simpson.currentRow,ex.simpson.currentCol);break;case"tay":drawImg(westImg,ex.simpson.currentRow,ex.simpson.currentCol);break;case"nam":drawImg(southImg,ex.simpson.currentRow,ex.simpson.currentCol);break;case"bac":drawImg(northImg,ex.simpson.currentRow,ex.simpson.currentCol);break;case"waterLost":drawImg(waterLostImg,ex.simpson.currentRow,ex.simpson.currentCol);break;case"rockLost":drawImg(rockLostImg,ex.simpson.currentRow,ex.simpson.currentCol)}}function quay_trai(){quayTrai()}function quayTrai(){switch(ex.simpson.direction){case"dong":ex.simpson.direction="bac",drawImg(northImg,ex.simpson.currentRow,ex.simpson.currentCol);break;case"tay":ex.simpson.direction="nam",drawImg(southImg,ex.simpson.currentRow,ex.simpson.currentCol);break;case"nam":ex.simpson.direction="dong",drawImg(eastImg,ex.simpson.currentRow,ex.simpson.currentCol);break;case"bac":ex.simpson.direction="tay",drawImg(westImg,ex.simpson.currentRow,ex.simpson.currentCol)}}function quay_phai(){quayPhai()}function quayPhai(){switch(ex.simpson.direction){case"dong":ex.simpson.direction="nam",drawImg(southImg,ex.simpson.currentRow,ex.simpson.currentCol);break;case"tay":ex.simpson.direction="bac",drawImg(northImg,ex.simpson.currentRow,ex.simpson.currentCol);break;case"nam":ex.simpson.direction="tay",drawImg(westImg,ex.simpson.currentRow,ex.simpson.currentCol);break;case"bac":ex.simpson.direction="dong",drawImg(eastImg,ex.simpson.currentRow,ex.simpson.currentCol)}}function tien_buoc(){tienBuoc()}function tienBuoc(){var e,t;switch(ex.simpson.direction){case"dong":e=ex.simpson.currentCol+1,t=ex.simpson.currentRow;break;case"tay":e=ex.simpson.currentCol-1,t=ex.simpson.currentRow;break;case"nam":t=ex.simpson.currentRow+1,e=ex.simpson.currentCol;break;case"bac":t=ex.simpson.currentRow-1,e=ex.simpson.currentCol}0==e||0==t||e>ex.matrix.ncol||t>ex.matrix.nrow?(errorFlag="Simpson đã đụng đầu vào tường",ex.simpson.direction="rockLost",drawSimpson()):(1==triggers[t-1][e-1]?(errorFlag="Simpson đã rơi xuống hồ",ex.simpson.direction="waterLost"):2==triggers[t-1][e-1]&&(errorFlag="Simson đã đâm đầu vào núi.",ex.simpson.direction="rockLost"),3===triggers[ex.simpson.currentRow-1][ex.simpson.currentCol-1]?drawImg(diamondImg,ex.simpson.currentRow,ex.simpson.currentCol):drawImg(backImg,ex.simpson.currentRow,ex.simpson.currentCol),ex.simpson.currentCol=e,ex.simpson.currentRow=t,drawSimpson())}function dao_kim_cuong(){daoKimCuong()}function daoKimCuong(){3==triggers[ex.simpson.currentRow-1][ex.simpson.currentCol-1]?(ex.simpson.nDias++,triggers[ex.simpson.currentRow-1][ex.simpson.currentCol-1]=0):errorFlag="Simpson nhặt phải đá rồi"}function tuong(e){return checkTrigger(e,-1)}function ho(e){return checkTrigger(e,1)}function nui(e){return checkTrigger(e,2)}function kimCuong(e){return e?checkTrigger(e,3):3==triggers[ex.simpson.currentRow-1][ex.simpson.currentCol-1]}function anToan(e){return!(tuong(e)||ho(e)||nui(e))}function nhinHuong(e){return simpson.direction==e}function checkTrigger(e,t){var n,o,s=!0;switch(e){case"ben trai":case"ben Trai":case"Ben trai":case"Ben Trai":case"bentrai":case"BenTrai":case"Bentrai":switch(ex.simpson.direction){case"dong":o=ex.simpson.currentRow-1,n=ex.simpson.currentCol;break;case"tay":o=ex.simpson.currentRow+1,n=ex.simpson.currentCol;break;case"bac":o=ex.simpson.currentRow,n=ex.simpson.currentCol-1;break;case"nam":o=ex.simpson.currentRow,n=ex.simpson.currentCol+1;break;default:throw{name:"DirectionError",message:"Lỗi Logic: Không thể xử lý hướng nhìn "+e+" (không xác định)."}}break;case"ben phai":case"ben Phai":case"Ben phai":case"Ben Phai":case"benphai":case"BenPhai":case"Benphai":switch(ex.simpson.direction){case"dong":o=ex.simpson.currentRow+1,n=ex.simpson.currentCol;break;case"tay":o=ex.simpson.currentRow-1,n=ex.simpson.currentCol;break;case"bac":o=ex.simpson.currentRow,n=ex.simpson.currentCol+1;break;case"nam":o=ex.simpson.currentRow,n=ex.simpson.currentCol-1;break;default:throw{name:"DirectionError",message:"Lỗi Logic: Simpson đã chết. Simpson không thể nhìn thấy gì nữa."}}break;case"phia truoc":case"phia Truoc":case"Phia truoc":case"Phia Truoc":case"phiatruoc":case"phiaTruoc":case"Phiatruoc":switch(ex.simpson.direction){case"dong":o=ex.simpson.currentRow,n=ex.simpson.currentCol+1;break;case"tay":o=ex.simpson.currentRow,n=ex.simpson.currentCol-1;break;case"bac":o=ex.simpson.currentRow-1,n=ex.simpson.currentCol;break;case"nam":o=ex.simpson.currentRow+1,n=ex.simpson.currentCol;break;default:throw{name:"DirectionError",message:"Lỗi Logic: Simpson đã chết. Simpson không thể nhìn thấy gì nữa."}}break;default:throw{name:"DirectionError",message:"Lỗi Logic: Không thể xử lý hướng nhìn "+e+" (không xác định)."}}return s?0==n||0==o||n>ex.matrix.ncol||o>ex.matrix.nrow?t==-1:triggers[o-1][n-1]==t:s}function removeMark(){marker&&(editor.getSession().removeMarker(marker),marker=null)}function initExecution(){var e=editor.getValue().trim();""!=e&&(executionStack.push({type:"BlockStatement",body:esprima.parse(e,esprimaOptions).body,index:0}),markStatement(executionStack[0]),console.log(executionStack))}function checkFinished(){removeMark(),executionStack.length>0&&"BlockStatement"==executionStack[executionStack.length-1].type&&executionStack[executionStack.length-1].index==executionStack[executionStack.length-1].body.length&&executionStack.pop(),0==executionStack.length?showWinOrLost():markStatement(executionStack[executionStack.length-1])}function execStatement(){if(executionStack.length){var s=executionStack.pop();switch(s.type){case"BlockStatement":if(s.index<s.body.length){var tmpStatement=s.body[s.index];s.index++,s.index<s.body.length&&executionStack.push(s),executionStack.push(tmpStatement),nextStep()}else 0==executionStack.length?showWinOrLost():nextStep();break;case"IfStatement":if(s.test){var a=s.test.loc.start.line-1,b=s.test.loc.start.column,c=s.test.loc.end.line-1,d=s.test.loc.end.column,testScript=editor.session.getTextRange(new Range(a,b,c,d));try{var testResult=eval(testScript);if(testResult)if(s.consequent){var tmpStatement={type:"BlockStatement",body:[],index:0};"BlockStatement"!=s.consequent.type?tmpStatement.body.push(s.consequent):tmpStatement.body=s.consequent.body,removeMark(),executionStack.push(tmpStatement),markStatement(tmpStatement)}else checkFinished();else if(s.alternate){var tmpStatement={type:"BlockStatement",body:[],index:0};"BlockStatement"!=s.alternate.type?tmpStatement.body.push(s.alternate):tmpStatement.body=s.alternate.body,removeMark(),executionStack.push(tmpStatement),markStatement(tmpStatement)}else checkFinished()}catch(e){processError(e,a)}}break;case"ExpressionStatement":case"VariableDeclaration":case"AssignmentExpression":var a=s.loc.start.line-1,b=s.loc.start.column,c=s.loc.end.line-1,d=s.loc.end.column,statementScript=editor.session.getTextRange(new Range(a,b,c,d));try{eval(statementScript)}catch(e){processError(e,a)}removeMark(),executionStack.length>0&&"BlockStatement"==executionStack[executionStack.length-1].type&&executionStack[executionStack.length-1].index==executionStack[executionStack.length-1].body.length&&executionStack.pop(),0==executionStack.length?showWinOrLost():markStatement(executionStack[executionStack.length-1]);break;case"WhileStatement":var a=s.test.loc.start.line-1,b=s.test.loc.start.column,c=s.test.loc.end.line-1,d=s.test.loc.end.column,testScript=editor.session.getTextRange(new Range(a,b,c,d)),testResult=eval(testScript);if(testResult){var tmpStatement={type:"BlockStatement",body:[],index:0};"BlockStatement"!=s.body.type?tmpStatement.body.push(s.body):tmpStatement.body=s.body.body,removeMark(),executionStack.push(s),executionStack.push(tmpStatement),markStatement(tmpStatement)}else checkFinished();break;case"DoWhileStatement":var testResult=!0;if(s.firstRunFlag){var a=s.test.loc.start.line-1,b=s.test.loc.start.column,c=s.test.loc.end.line-1,d=s.test.loc.end.column,testScript=editor.session.getTextRange(new Range(a,b,c,d));try{testResult=eval(testScript)}catch(e){processError(e,a)}}else s.firstRunFlag=!0;if(testResult){var tmpStatement={type:"BlockStatement",body:[],index:0};"BlockStatement"!=s.body.type?tmpStatement.body.push(s.body):tmpStatement.body=s.body.body,removeMark(),executionStack.push(s),executionStack.push(tmpStatement),markStatement(tmpStatement)}else checkFinished();break;default:console.log("Not support "+s.type)}}}function execContinuously(){!errorFlag&&executionStack.length>0&&(execStatement(),pauseFlag||setTimeout(execContinuously,250))}function forceBreakPoint(e){var t=editor.session.getBreakpoints(e,0);"undefined"!=typeof t[e]&&(pauseFlag=!0)}function markStatement(e){if(e)switch(e.type){case"WhileStatement":case"IfStatement":var t=e.test.loc.start.line-1,n=e.test.loc.start.column,o=e.test.loc.end.line-1,s=e.test.loc.end.column;marker=editor.session.addMarker(new Range(t,n,o,s),"nextExecMarker","text");var r=editor.session.getBreakpoints(t,0);"undefined"!=typeof r[t]&&(pauseFlag=!0),editor.scrollToLine(o,!0,!0,function(){});break;case"DoWhileStatement":if(e.firstRunFlag){var t=e.test.loc.start.line-1,n=e.test.loc.start.column,o=e.test.loc.end.line-1,s=e.test.loc.end.column;marker=editor.session.addMarker(new Range(t,n,o,s),"nextExecMarker","text"),forceBreakPoint(t),editor.scrollToLine(o,!0,!0,function(){})}else markStatement(e.body);break;case"ExpressionStatement":case"VariableDeclaration":case"AssignmentExpression":var t=e.loc.start.line-1,n=e.loc.start.column,o=e.loc.end.line-1,s=e.loc.end.column;marker=editor.session.addMarker(new Range(t,n,o,s),"nextExecMarker","text");var r=editor.session.getBreakpoints(t,0);"undefined"!=typeof r[t]&&(pauseFlag=!0),editor.scrollToLine(o,!0,!0,function(){});break;case"BlockStatement":void 0===e.index&&(e.index=0),markStatement(e.index<e.body.length?e.body[e.index]:executionStack[executionStack.length-2]);break;default:console.log("MarkStatement do not support "+e.type)}}function processError(e,t){var n=["quayTrai","quayPhai","tienBuoc","daoKimCuong","tuong","ho","nui","kimCuong"];if("ReferenceError"==e.name){var o=e.message.split(" ")[0],s=n.map(function(e){return e.toUpperCase()}).indexOf(o.toUpperCase());errorFlag=s>-1?"Xin lỗi Simpson không hiểu "+o+". Có phải bạn muốn Simpson thực hiện "+n[s]+"?":e.message}else errorFlag=e.message;editor.getSession().setAnnotations([{row:t,text:errorFlag,type:"error"}])}function showWinOrLost(){errorFlag=-2,ex.simpson.nDias==ex.simpson.rDias?(document.getElementById("modalImg").src="simpson/win.png",document.getElementById("modalMessage").innerHTML="Good Code",document.getElementById("nextBtn").style.display="block",modal.style.display="block"):(document.getElementById("modalImg").src="simpson/lost.png",document.getElementById("modalMessage").innerHTML="Logical Error. Simpson chưa thu thập được đủ "+ex.simpson.rDias+" viên kim cương.",document.getElementById("nextBtn").style.display="none",modal.style.display="block")}function nextStep(){errorFlag||!executionStack.length?(reset(),initExecution()):execStatement()}function runContinuously(){(continuable||errorFlag||!executionStack.length||pauseFlag)&&(errorFlag||!executionStack.length?(reset(),initExecution(),continuable=!1,setTimeout(execContinuously,250)):(pauseFlag=!1,execContinuously()))}function reset(){executionStack=[],marker&&editor.getSession().removeMarker(marker),marker=null,pauseFlag=!1,errorFlag=!1,continuable=!0,triggers=null,ex.simpson.currentCol=ex.simpson.initCol,ex.simpson.currentRow=ex.simpson.initRow,ex.simpson.direction=ex.simpson.initDirection,ex.simpson.nDias=ex.simpson.initNDias,initVisualView()}function pause(){pauseFlag=!0}function goNext(){document.getElementById("myModal").style.display="none",Reveal.right()}function getData(e,t){var n=new XMLHttpRequest;n.onreadystatechange=function(){4==this.readyState&&200==this.status&&t(this.responseText)},n.open("GET",e,!0),n.send()}function createMatrix(e,t,n){for(var o=[],s=0;s<e;s++){o.push([]),o[s].push(new Array(t));for(var r=0;r<t;r++)o[s][r]=n}return o}var chapter=null,codingSlides=[];navigationClick(null,"chapter1");var ex=null,triggers=null,canvas=document.getElementById("executionView"),context=null;backImg=new Image,backImg.src="simpson/bckground.png",holeImg=new Image,holeImg.src="simpson/water.jpg",rockImg=new Image,rockImg.src="simpson/rock.jpg",eastImg=new Image,eastImg.src="simpson/east.jpg",westImg=new Image,westImg.src="simpson/west.jpg",southImg=new Image,southImg.src="simpson/south.jpg",northImg=new Image,northImg.src="simpson/north.jpg",waterLostImg=new Image,waterLostImg.src="simpson/underWater.jpg",rockLostImg=new Image,rockLostImg.src="simpson/dieWall.jpg",diamondImg=new Image,diamondImg.src="simpson/diam.jpg",markedDiaImg=new Image,markedDiaImg.src="simpson/markDiamond.jpg";var editor=ace.edit("editor"),Range=ace.require("ace/range").Range,marker=null;editor.setTheme("ace/theme/xcode"),editor.getSession().setMode("ace/mode/javascript"),editor.on("guttermousedown",function(e){var t=e.domEvent.target;if(t.className.indexOf("ace_gutter-cell")!=-1&&editor.isFocused()&&!(e.clientX>25+t.getBoundingClientRect().left)){var n=e.getDocumentPosition().row,o=e.editor.session.getBreakpoints(n,0);"undefined"==typeof o[n]?e.editor.session.setBreakpoint(n):e.editor.session.clearBreakpoint(n),e.stop()}}),esprimaOptions={attachComment:!1,range:!1,loc:!0,sourceType:"script"};var executionStack=[],pauseFlag=!1,errorFlag=!1,continuable=!0,modal=document.getElementById("myModal");window.onclick=function(e){e.target==modal&&(modal.style.display="none")};